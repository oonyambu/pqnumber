"0",""
"0","pqnumber <- function(sign, p, q, nums){"
"0","  "
"0","  if(any(sign != floor(sign), !sign %in% c(-1,1), length(sign)!= 1))"
"0","    stop(""sign must be either -1L or 1L"", call. = FALSE)"
"0","  "
"0",""
"0","  if(any(p!=floor(p), p < 0, length(p) != 1))"
"0","    stop(""p must be a single non-negative integer"", call. = FALSE)"
"0","  "
"0","  if(any(q!=floor(q), q < 0, length(q) != 1))"
"0","    stop(""q must be a single non-negative integer"", call. = FALSE)"
"0","  "
"0","  if(p + q + 1 != length(nums))"
"0","    stop(""p + q + 1 must equal length(nums)"", call. = FALSE)"
"0","  if(any( nums < 0 , nums != floor(nums), nums > 9, na.rm = TRUE))"
"0","    stop(""nums must contain integers[0-9]"", call. = FALSE)"
"0","  "
"0","  if(sign == 0) nums <- nums*sign"
"0","  structure(list(sign = as.integer(sign),"
"0","                 p = as.integer(p), "
"0","                 q = as.integer(q),"
"0","                 nums = as.integer(nums)),"
"0","            class = ""pqnumber"")"
"0","}"
"0",""
"0","drop_zeros <- function(x){"
"0","  p <- x$p; q <- x$q; nums <- x$nums"
"0","  index <- which(nums>0)"
"0","  mx <- max(index, 0)"
"0","  mn <- min(index, mx)"
"0","  new_p <- max(0, p - mn + 1)"
"0","  k=new_q <- max(0, mx - p - 1)"
"0","  nums_new <- head(nums, p + new_q+1)|>"
"0","    tail(new_q + new_p + 1)"
"0","  list(sign=x$sign, p=new_p, q=new_q, nums=nums_new) "
"0","}"
"0","is_pqnumber <- function(x) {"
"0","  inherits(x, ""pqnumber"") &&"
"0","      !isFALSE(tryCatch(do.call(pqnumber, x), error = \(x)FALSE))"
"0","}"
"0",""
"0",""
"0","format.pqnumber <- function(x, digits = getOption('digits'), scientific = FALSE, ...){"
"0","  x <- drop_zeros(x)"
"0","  q <- x$q"
"0","  nums <- rev(x$nums)"
"0","  index <- which.max(nums > 0)"
"0","  sgn <- if(x$sign>0)"""" else ""-"""
"0","  if(x$p > digits && index > 5|| q > digits){"
"0","    if(q == 0){"
"0","      q <- 1 - index"
"0","      nums <- tail(nums, 1-index)"
"0","    }"
"0","    second <- head(nums[-1], digits)"
"0","    if(all(second == 0)) nums <- nums[1]"
"0","    else {"
"0","      nums <- c(nums[1], second[rev(cummax(rev(second))!=0)])"
"0","    }"
"0","    dec <- if(length(nums)>1)""."" else """""
"0","    sprintf(""%s%d%s%se%+d"", sgn,"
"0","            nums[1], dec,"
"0","            paste0(head(nums[-1], digits), collapse = """"), q)"
"0","  }"
"0","  else  {"
"0","    nums <- head(nums, max(10,q + min(x$p, abs(digits - q))))"
"0","    dec <- if(length(nums) > q+1)""."" else """""
"0","    paste0(c(sgn, append(nums, dec, q + 1)), collapse = """")"
"0","  }"
"0","}"
"0",""
"0","as_pqnumber <- function(x, ...) UseMethod('as_pqnumber')"
"0",""
"0","as_pqnumber.default <- function(x, p = NULL, q = NULL){"
"0","  get_num <- function(x){"
"0","    v <- strsplit(x, ""[.]"")[[1]]"
"0","    q <- nchar(v[1]) - 1"
"0","    p <- if(length(v) == 2) nchar(v[2]) else 0"
"0","    nums <- rev(as.integer(unlist(strsplit(v, """"))))"
"0","    list(p=p, q=q, nums=nums)"
"0","  }"
"0",""
"0","  "
"0","  get_num2 <- function(x){"
"0","    v <- strsplit(x, ""[eE]"")[[1]]"
"0","    u <- get_num(v[1])"
"0","    q <- u$q+as.integer(v[2])"
"0","    nums <- u$nums"
"0","    n <- length(nums)"
"0","    p <- n- q - 1"
"0","    if(q < 0) nums <- c(nums, numeric(-q))"
"0","    if(p < 0) nums <- c(numeric(-p), nums)"
"0","    list(p = max(0, p), q=max(q, 0), nums=nums)"
"0","  }"
"0","  "
"0","  nums <- function(x){"
"0","    x <- as.character(x)"
"0","    valid <- grepl(""^-?\\d+([.]\\d*)?([eE][-+]?\\d+)?$"", x)"
"0","    if(!valid) stop(""Invalid input x"", call. = FALSE)"
"0","    sign <- if(grepl(""^-"", x)) -1 else 1"
"0","    x <- sub(""^-"", """", x)"
"0","    val <- if(grepl(""[eE]"", x)) get_num2(x) else get_num(x)"
"0","    c(sign=sign, val)"
"0","  }"
"0","  as_pqnumber.pqnumber(do.call(pqnumber, nums(x)), p, q)"
"0","}"
"0",""
"0","as_pqnumber.pqnumber <- function(x, p = NULL, q = NULL){"
"0","  if(is.null(q) && is.null(p)) return(x)"
"0","  if(is.null(q)) q <- x$q"
"0","  if(q < x$q) stop(""q cannot be less than "", x$q, call. = FALSE)"
"0","  if(q > x$q){"
"0","    x$nums <- c(x$nums, numeric(q - x$q))"
"0","    x$q <- q"
"0","  }"
"0","  if(p < x$p) {"
"0","    m <- x$p - p "
"0","    x$nums[m + 1] <- round(x$nums[m]) %/% 10 + x$nums[m + 1]"
"0","    x$nums <- tail(x$nums, p + x$q + 1)"
"0","    x$p <- p"
"0","  }"
"0","  if(p > x$p){"
"0","    x$nums <- c(numeric(p - x$p), x$nums)"
"0","    x$p <- p"
"0","  }"
"0","  x"
"0","}"
