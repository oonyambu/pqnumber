packageVersion("Rcpp")
devtools::document()
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
pqnumber <- function(sign, p, q, nums){
if(any(sign != floor(sign), !sign %in% c(-1,1), length(sign)!= 1))
stop("sign must be either -1L or 1L", call. = FALSE)
if(any(p!=floor(p), p < 0, length(p) != 1))
stop("p must be a single non-negative integer", call. = FALSE)
if(any(q!=floor(q), q < 0, length(q) != 1))
stop("q must be a single non-negative integer", call. = FALSE)
if(p + q + 1 != length(nums))
stop("p + q + 1 must equal length(nums)", call. = FALSE)
if(any( nums < 0 , nums != floor(nums), nums > 9, na.rm = TRUE))
stop("nums must contain integers[0-9]", call. = FALSE)
if(sign == 0) nums <- nums*sign
structure(list(sign = as.integer(sign),
p = as.integer(p),
q = as.integer(q),
nums = as.integer(nums)),
class = "pqnumber")
}
drop_zeros <- function(x){
p <- x$p; q <- x$q; nums <- x$nums
index <- which(nums>0)
mx <- max(index, 0)
mn <- min(index, mx)
new_p <- max(0, p - mn + 1)
k=new_q <- max(0, mx - p - 1)
nums_new <- head(nums, p + new_q+1)|>
tail(new_q + new_p + 1)
list(sign=x$sign, p=new_p, q=new_q, nums=nums_new)
}
is_pqnumber <- function(x) {
inherits(x, "pqnumber") &&
!isFALSE(tryCatch(do.call(pqnumber, x), error = \(x)FALSE))
}
format.pqnumber <- function(x, digits = getOption('digits'), scientific = FALSE, ...){
x <- drop_zeros(x)
q <- x$q
nums <- rev(x$nums)
index <- which.max(nums > 0)
sgn <- if(x$sign>0)"" else "-"
if(x$p > digits && index > 5|| q > digits){
if(q == 0){
q <- 1 - index
nums <- tail(nums, 1-index)
}
second <- head(nums[-1], digits)
if(all(second == 0)) nums <- nums[1]
else {
nums <- c(nums[1], second[rev(cummax(rev(second))!=0)])
}
dec <- if(length(nums)>1)"." else ""
sprintf("%s%d%s%se%+d", sgn,
nums[1], dec,
paste0(head(nums[-1], digits), collapse = ""), q)
}
else  {
nums <- head(nums, max(10,q + min(x$p, abs(digits - q))))
dec <- if(length(nums) > q+1)"." else ""
paste0(c(sgn, append(nums, dec, q + 1)), collapse = "")
}
as_pqnumber <- function(x, ...) UseMethod('as_pqnumber')
as_pqnumber.default <- function(x, p = NULL, q = NULL){
get_num <- function(x){
v <- strsplit(x, "[.]")[[1]]
q <- nchar(v[1]) - 1
p <- if(length(v) == 2) nchar(v[2]) else 0
nums <- rev(as.integer(unlist(strsplit(v, ""))))
list(p=p, q=q, nums=nums)
}
get_num2 <- function(x){
v <- strsplit(x, "[eE]")[[1]]
u <- get_num(v[1])
q <- u$q+as.integer(v[2])
nums <- u$nums
n <- length(nums)
p <- n- q - 1
if(q < 0) nums <- c(nums, numeric(-q))
if(p < 0) nums <- c(numeric(-p), nums)
list(p = max(0, p), q=max(q, 0), nums=nums)
}
nums <- function(x){
x <- as.character(x)
valid <- grepl("^-?\\d+([.]\\d*)?([eE][-+]?\\d+)?$", x)
if(!valid) stop("Invalid input x", call. = FALSE)
sign <- if(grepl("^-", x)) -1 else 1
x <- sub("^-", "", x)
val <- if(grepl("[eE]", x)) get_num2(x) else get_num(x)
c(sign=sign, val)
}
as_pqnumber.pqnumber(do.call(pqnumber, nums(x)), p, q)
}
as_pqnumber.pqnumber <- function(x, p = NULL, q = NULL){
if(is.null(q) && is.null(p)) return(x)
if(is.null(q)) q <- x$q
if(q < x$q) stop("q cannot be less than ", x$q, call. = FALSE)
if(q > x$q){
x$nums <- c(x$nums, numeric(q - x$q))
x$q <- q
}
if(p < x$p) {
m <- x$p - p
x$nums[m + 1] <- round(x$nums[m]) %/% 10 + x$nums[m + 1]
x$nums <- tail(x$nums, p + x$q + 1)
x$p <- p
}
if(p > x$p){
x$nums <- c(numeric(p - x$p), x$nums)
x$p <- p
}
x
}
as_pqnumber("123")
as_pqnumber("123e-5000")
